<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Paskibra</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Lucide Icons for better UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- html5-qrcode for QR Scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Custom font and scrollbar styling for a better look */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://rsms.me/inter/inter.css');
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Login Page -->
        <div id="loginPage" class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg text-center">
                <div class="flex justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M14.5 9.5 21 3m-5 13.5 6.5 6.5M12 22V2M3 10h18M3 2h18"/></svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900">Absensi Paskibra</h1>
                <p class="text-gray-600">Silakan masuk sesuai dengan peran Anda.</p>
                <div class="space-y-4">
                    <button id="loginAdminBtn" class="w-full flex items-center justify-center gap-2 bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105">
                        <i data-lucide="user-cog"></i>
                        <span>Masuk sebagai Admin</span>
                    </button>
                    <button id="loginUserBtn" class="w-full flex items-center justify-center gap-2 bg-gray-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-700 transition-transform transform hover:scale-105">
                         <i data-lucide="user"></i>
                        <span>Isi Absensi Anggota</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- User/Member Page -->
        <div id="userPage" class="hidden">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">Formulir Absensi Anggota</h2>
                
                <button id="scanQRBtn" class="w-full flex items-center justify-center gap-2 mb-6 bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                    <i data-lucide="camera"></i>
                    <span>Hadir dengan Scan QR Code</span>
                </button>

                <div id="qrScannerModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg text-center">
                        <h3 class="text-xl font-bold mb-4">Arahkan QR Code ke Kamera</h3>
                        <div id="qr-reader" class="w-full rounded-lg overflow-hidden"></div>
                        <button id="closeScannerBtn" class="mt-4 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Tutup</button>
                    </div>
                </div>

                <form id="attendanceForm" class="space-y-6">
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Anggota</label>
                        <input type="text" id="nama" name="nama" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Asal Kelas</label>
                        <input type="text" id="kelas" name="kelas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="tanggal" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Latihan</label>
                        <input type="date" id="tanggal" name="tanggal" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <p id="dateWarning" class="text-red-500 text-xs mt-1 hidden">Jadwal latihan hanya pada hari Selasa dan Jumat.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status Kehadiran</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input id="hadir" name="status" type="radio" value="Hadir" checked class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                                <label for="hadir" class="ml-2 block text-sm text-gray-900">Hadir</label>
                            </div>
                            <div class="flex items-center">
                                <input id="telat" name="status" type="radio" value="Telat" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                                <label for="telat" class="ml-2 block text-sm text-gray-900">Telat</label>
                            </div>
                            <div class="flex items-center">
                                <input id="sakit" name="status" type="radio" value="Sakit" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                                <label for="sakit" class="ml-2 block text-sm text-gray-900">Sakit</label>
                            </div>
                             <div class="flex items-center">
                                <input id="izin" name="status" type="radio" value="Izin" class="h-4 w-4 text-red-600 border-gray-300 focus:ring-red-500">
                                <label for="izin" class="ml-2 block text-sm text-gray-900">Izin</label>
                            </div>
                        </div>
                    </div>
                    <div id="keteranganContainer" class="hidden">
                        <label for="keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Sakit/Izin)</label>
                        <textarea id="keterangan" name="keterangan" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    <div id="materiContainer">
                        <label for="materi" class="block text-sm font-medium text-gray-700 mb-1">Materi yang Diikuti Hari Ini</label>
                        <textarea id="materi" name="materi" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                     <div class="flex items-center justify-between pt-4">
                        <button type="button" id="backToLoginUser" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Kembali</button>
                        <button type="submit" id="submitBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105">
                            <span id="submitSpinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Kirim Absensi
                        </button>
                    </div>
                    <div id="userMessage" class="text-center mt-4"></div>
                </form>
            </div>
        </div>
        
        <!-- Admin Page -->
        <div id="adminPage" class="hidden space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold">Dashboard Admin</h2>
                <button id="backToLoginAdmin" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors flex items-center gap-2">
                    <i data-lucide="arrow-left"></i>
                    <span>Kembali</span>
                </button>
            </div>

            <!-- Recap Section -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                     <h3 class="text-xl font-bold mb-4 md:mb-0">Rekapitulasi Kehadiran Anggota</h3>
                     <button id="downloadExcelBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center gap-2 self-start md:self-center">
                        <i data-lucide="file-down"></i>
                        <span>Unduh Rekap (Excel)</span>
                    </button>
                </div>
                <div id="recapLoader" class="text-center py-4">Memuat data rekapitulasi...</div>
                <div id="recapContent" class="hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <p class="text-sm text-blue-800 font-semibold">Total Anggota</p>
                            <p id="totalAnggota" class="text-2xl font-bold text-blue-900">0</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <p class="text-sm text-green-800 font-semibold">Total Hadir</p>
                            <p id="totalHadir" class="text-2xl font-bold text-green-900">0</p>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-lg">
                            <p class="text-sm text-yellow-800 font-semibold">Total Sakit</p>
                            <p id="totalSakit" class="text-2xl font-bold text-yellow-900">0</p>
                        </div>
                        <div class="bg-orange-100 p-4 rounded-lg">
                            <p class="text-sm text-orange-800 font-semibold">Total Izin</p>
                            <p id="totalIzin" class="text-2xl font-bold text-orange-900">0</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto no-scrollbar rounded-lg border border-gray-200">
                        <table id="recapTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Anggota</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Telat</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">% Kehadiran</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Poin</th>
                                </tr>
                            </thead>
                            <tbody id="recapTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Data Rekap akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Documentation Section -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Dokumentasi Kegiatan</h3>
                <form id="photoUploadForm" class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 space-y-4">
                    <div>
                        <label for="photoFile" class="block text-sm font-medium text-gray-700 mb-1">Upload Foto Kegiatan</label>
                        <input type="file" id="photoFile" accept="image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                    </div>
                    <div>
                        <label for="photoDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kegiatan</label>
                        <input type="date" id="photoDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div>
                        <label for="photoDescription" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Singkat</label>
                        <textarea id="photoDescription" rows="2" placeholder="Contoh: Latihan PBB Dasar" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>
                    <button type="submit" id="uploadBtn" class="w-full bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-red-700 flex items-center justify-center gap-2">
                        <span id="uploadSpinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                        <i data-lucide="upload-cloud"></i>
                        <span>Upload Dokumentasi</span>
                    </button>
                    <div id="uploadMessage" class="text-center mt-2 text-sm"></div>
                </form>
                
                <div id="photoGalleryLoader" class="text-center py-4">Memuat galeri foto...</div>
                <div id="photoGallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Photos will be rendered here by JS -->
                </div>
            </div>

            <!-- Attendance List Section -->
             <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Daftar Absensi Keseluruhan</h3>
                <div id="attendanceLoader" class="text-center py-4">Memuat data absensi...</div>
                <div class="overflow-x-auto no-scrollbar rounded-lg border border-gray-200">
                    <table id="attendanceTable" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Data Absensi akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'paskibra-absensi-app';
        
        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        let userId = null;
        let unsubscribe = null; // To detach listener
        const attendanceCollectionRef = collection(db, `/artifacts/${appId}/public/data/absensi_paskibra`);
        const documentationCollectionRef = collection(db, `/artifacts/${appId}/public/data/dokumentasi_paskibra`);

        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('loginPage');
        const userPage = document.getElementById('userPage');
        const adminPage = document.getElementById('adminPage');

        const loginAdminBtn = document.getElementById('loginAdminBtn');
        const loginUserBtn = document.getElementById('loginUserBtn');
        const backToLoginUser = document.getElementById('backToLoginUser');
        const backToLoginAdmin = document.getElementById('backToLoginAdmin');

        const scanQRBtn = document.getElementById('scanQRBtn');
        const qrScannerModal = document.getElementById('qrScannerModal');
        const closeScannerBtn = document.getElementById('closeScannerBtn');
        let html5QrCode = null;

        const attendanceForm = document.getElementById('attendanceForm');
        const tanggalInput = document.getElementById('tanggal');
        const dateWarning = document.getElementById('dateWarning');
        const keteranganContainer = document.getElementById('keteranganContainer');
        const materiContainer = document.getElementById('materiContainer');
        const keteranganInput = document.getElementById('keterangan');
        const userMessage = document.getElementById('userMessage');
        const submitBtn = document.getElementById('submitBtn');
        const submitSpinner = document.getElementById('submitSpinner');
        
        const attendanceTable = document.getElementById('attendanceTable');
        const attendanceTableBody = document.getElementById('attendanceTableBody');
        const recapTableBody = document.getElementById('recapTableBody');
        const recapLoader = document.getElementById('recapLoader');
        const attendanceLoader = document.getElementById('attendanceLoader');
        const recapContent = document.getElementById('recapContent');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');

        const photoUploadForm = document.getElementById('photoUploadForm');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const uploadMessage = document.getElementById('uploadMessage');
        const photoGallery = document.getElementById('photoGallery');
        const photoGalleryLoader = document.getElementById('photoGalleryLoader');

        // --- PAGE NAVIGATION ---
        function showPage(pageId) {
            [loginPage, userPage, adminPage].forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        loginAdminBtn.addEventListener('click', () => {
            showPage('adminPage');
            fetchAttendanceData();
            fetchAndRenderPhotos();
        });
        loginUserBtn.addEventListener('click', () => showPage('userPage'));
        backToLoginUser.addEventListener('click', () => showPage('loginPage'));
        backToLoginAdmin.addEventListener('click', () => {
             showPage('loginPage');
             if (unsubscribe) {
                 unsubscribe(); // Detach listener when leaving admin page
             }
        });
        
        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                 try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    userMessage.textContent = 'Gagal mengautentikasi. Silakan coba lagi.';
                }
            }
        });

        // --- USER PAGE LOGIC ---
        
        // QR Scanner Logic
        function initQRScanner() {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }
            
            const onScanSuccess = (decodedText, decodedResult) => {
                const [nama, kelas] = decodedText.split('|');
                if (nama && kelas) {
                    document.getElementById('nama').value = nama.trim();
                    document.getElementById('kelas').value = kelas.trim();
                    document.getElementById('hadir').checked = true;
                    document.getElementById('hadir').dispatchEvent(new Event('change'));
                    
                    userMessage.textContent = 'Data dari QR berhasil dimuat!';
                    userMessage.className = 'text-blue-600';
                    setTimeout(() => userMessage.textContent = '', 3000);

                    closeScanner();
                } else {
                    alert("Format QR code tidak valid. Harusnya: Nama Lengkap|Kelas");
                }
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .catch(err => {
                    console.error("Unable to start scanning.", err);
                    alert("Gagal memulai kamera. Pastikan Anda memberikan izin kamera.");
                });
        }

        function closeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Failed to stop scanning.", err));
            }
            qrScannerModal.classList.add('hidden');
        }

        scanQRBtn.addEventListener('click', () => {
            qrScannerModal.classList.remove('hidden');
            initQRScanner();
        });
        closeScannerBtn.addEventListener('click', closeScanner);

        // Date validation for Tuesday (2) and Friday (5)
        tanggalInput.addEventListener('change', () => {
            const selectedDate = new Date(tanggalInput.value);
            const day = new Date(selectedDate.getTime() + selectedDate.getTimezoneOffset() * 60000).getDay();
            if (day !== 2 && day !== 5) {
                dateWarning.classList.remove('hidden');
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            } else {
                dateWarning.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        });
        
        tanggalInput.value = new Date().toISOString().split('T')[0];
        
        // Show/hide keterangan/materi based on status
        attendanceForm.status.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'Sakit' || e.target.value === 'Izin') {
                    keteranganContainer.classList.remove('hidden');
                    materiContainer.classList.add('hidden');
                    keteranganInput.required = true;
                } else {
                    keteranganContainer.classList.add('hidden');
                    materiContainer.classList.remove('hidden');
                    keteranganInput.required = false;
                }
            });
        });

        // Form submission
        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) {
                userMessage.textContent = 'Autentikasi belum siap. Coba beberapa saat lagi.';
                userMessage.className = 'text-red-500';
                return;
            }
            submitBtn.disabled = true;
            submitSpinner.classList.remove('hidden');
            userMessage.textContent = '';

            const formData = new FormData(attendanceForm);
            const status = formData.get('status');
            const attendanceData = {
                nama: formData.get('nama').trim(),
                kelas: formData.get('kelas').trim(),
                tanggal: formData.get('tanggal'),
                status: status,
                keterangan: (status === 'Sakit' || status === 'Izin') ? formData.get('keterangan').trim() : '',
                materi: (status === 'Hadir' || status === 'Telat') ? formData.get('materi').trim() : '',
                timestamp: new Date()
            };

            try {
                await addDoc(attendanceCollectionRef, attendanceData);
                userMessage.textContent = 'Absensi berhasil dikirim!';
                userMessage.className = 'text-green-600';
                attendanceForm.reset();
                tanggalInput.value = new Date().toISOString().split('T')[0];
                setTimeout(() => userMessage.textContent = '', 3000);
            } catch (error) {
                console.error("Error adding document: ", error);
                userMessage.textContent = 'Terjadi kesalahan. Coba lagi.';
                userMessage.className = 'text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitSpinner.classList.add('hidden');
            }
        });


        // --- ADMIN PAGE LOGIC ---
        let allAttendanceData = [];

        function fetchAttendanceData() {
            recapLoader.style.display = 'block';
            attendanceLoader.style.display = 'block';
            recapContent.classList.add('hidden');
            attendanceTable.classList.add('hidden');

            const q = query(attendanceCollectionRef);

            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const attendances = [];
                querySnapshot.forEach((doc) => {
                    attendances.push({ id: doc.id, ...doc.data() });
                });
                
                attendances.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                allAttendanceData = attendances;

                renderAttendanceTable(allAttendanceData);
                calculateAndRenderRecap(allAttendanceData);

                recapLoader.style.display = 'none';
                attendanceLoader.style.display = 'none';
                recapContent.classList.remove('hidden');
                attendanceTable.classList.remove('hidden');
            }, (error) => {
                console.error("Error fetching data: ", error);
                recapLoader.textContent = 'Gagal memuat data.';
                attendanceLoader.textContent = 'Gagal memuat data.';
            });
        }
        
        function renderAttendanceTable(data) {
            attendanceTableBody.innerHTML = '';
            if (data.length === 0) {
                 attendanceTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada data absensi.</td></tr>`;
                 return;
            }
            data.forEach(item => {
                const statusClasses = {
                    'Hadir': 'bg-green-100 text-green-800',
                    'Sakit': 'bg-yellow-100 text-yellow-800',
                    'Izin': 'bg-orange-100 text-orange-800',
                    'Telat': 'bg-purple-100 text-purple-800'
                };
                const statusClass = statusClasses[item.status] || 'bg-gray-100 text-gray-800';
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${item.tanggal}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${item.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.keterangan || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.materi || '-'}</td>
                    </tr>
                `;
                attendanceTableBody.innerHTML += row;
            });
        }
        
        function getUniqueTrainingDates(data) {
            return new Set(data.map(item => item.tanggal)).size;
        }

        function calculateAndRenderRecap(data) {
            const memberStats = {};
            let totalHadir = 0, totalSakit = 0, totalIzin = 0, totalTelat = 0;
            
            const totalTrainingDays = getUniqueTrainingDates(data);

            data.forEach(item => {
                const nameKey = item.nama.toLowerCase().trim();
                if (!memberStats[nameKey]) {
                    memberStats[nameKey] = {
                        nama: item.nama, kelas: item.kelas, hadir: 0, sakit: 0, izin: 0, telat: 0, alpha: 0, poin: 0
                    };
                }
                
                memberStats[nameKey].kelas = item.kelas;

                switch(item.status) {
                    case 'Hadir': memberStats[nameKey].hadir++; totalHadir++; break;
                    case 'Sakit': memberStats[nameKey].sakit++; totalSakit++; break;
                    case 'Izin': memberStats[nameKey].izin++; totalIzin++; break;
                    case 'Telat': memberStats[nameKey].telat++; totalTelat++; break;
                }
            });
            
            const totalAnggota = Object.keys(memberStats).length;
            
            Object.values(memberStats).forEach(member => {
                 const totalAbsensi = member.hadir + member.sakit + member.izin + member.telat;
                 member.alpha = totalTrainingDays > totalAbsensi ? totalTrainingDays - totalAbsensi : 0;
                 member.poin = (member.hadir * 10) + (member.telat * 5) - (member.alpha * 10);
            });

            document.getElementById('totalAnggota').textContent = totalAnggota;
            document.getElementById('totalHadir').textContent = totalHadir;
            document.getElementById('totalSakit').textContent = totalSakit;
            document.getElementById('totalIzin').textContent = totalIzin;

            recapTableBody.innerHTML = '';
            if (totalAnggota === 0) {
                 recapTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">Belum ada data untuk direkap.</td></tr>`;
                 return;
            }
            
            const sortedMembers = Object.values(memberStats).sort((a, b) => a.nama.localeCompare(b.nama));
            
            sortedMembers.forEach(member => {
                const totalPresence = member.hadir + member.telat;
                const attendancePercentage = totalTrainingDays > 0 ? ((totalPresence / totalTrainingDays) * 100).toFixed(1) : 0;
                const percentageClass = attendancePercentage >= 80 ? 'text-green-600' : attendancePercentage >= 60 ? 'text-yellow-600' : 'text-red-600';
                const poinClass = member.poin > 0 ? 'text-blue-600' : member.poin < 0 ? 'text-red-600' : 'text-gray-600';

                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${member.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${member.hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${member.telat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${member.sakit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${member.izin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${member.alpha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold ${percentageClass}">${attendancePercentage}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold ${poinClass}">${member.poin}</td>
                    </tr>
                `;
                recapTableBody.innerHTML += row;
            });
        }

        // Photo Upload & Gallery Logic
        photoUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('photoFile').files[0];
            const date = document.getElementById('photoDate').value;
            const description = document.getElementById('photoDescription').value;
            if (!file || !date || !description) return;

            uploadBtn.disabled = true;
            uploadSpinner.classList.remove('hidden');
            uploadMessage.textContent = '';
            try {
                const storageRef = ref(storage, `dokumentasi/${Date.now()}_${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                await addDoc(documentationCollectionRef, { imageUrl: downloadURL, tanggal: date, deskripsi: description, timestamp: new Date() });
                uploadMessage.textContent = 'Foto berhasil diupload!';
                uploadMessage.className = 'text-green-600';
                photoUploadForm.reset();
            } catch (error) {
                console.error("Upload error:", error);
                uploadMessage.textContent = 'Gagal mengupload foto.';
                uploadMessage.className = 'text-red-600';
            } finally {
                uploadBtn.disabled = false;
                uploadSpinner.classList.add('hidden');
                setTimeout(() => uploadMessage.textContent = '', 4000);
            }
        });

        function fetchAndRenderPhotos() {
            photoGalleryLoader.style.display = 'block';
            photoGallery.innerHTML = '';
            const q = query(documentationCollectionRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                photoGallery.innerHTML = '';
                if (snapshot.empty) {
                    photoGalleryLoader.textContent = 'Belum ada foto dokumentasi.';
                } else {
                    photoGalleryLoader.style.display = 'none';
                    snapshot.forEach((doc) => {
                        const photo = doc.data();
                        photoGallery.innerHTML += `
                            <div class="group relative overflow-hidden rounded-lg shadow-md">
                                <img src="${photo.imageUrl}" alt="${photo.deskripsi}" class="w-full h-48 object-cover transform group-hover:scale-110 transition-transform duration-300">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 transition-all duration-300 flex flex-col justify-end p-3">
                                    <p class="text-white text-sm font-semibold opacity-0 group-hover:opacity-100 transition-opacity">${photo.deskripsi}</p>
                                    <p class="text-gray-300 text-xs opacity-0 group-hover:opacity-100 transition-opacity">${photo.tanggal}</p>
                                </div>
                            </div>
                        `;
                    });
                }
            }, (error) => {
                console.error("Error fetching photos:", error);
                photoGalleryLoader.textContent = 'Gagal memuat galeri.';
            });
        }
        
        // EXCEL EXPORT
        downloadExcelBtn.addEventListener('click', () => {
             const recapData = [];
             const recapRows = recapTableBody.querySelectorAll('tr');
             if(recapRows.length === 0 || (recapRows.length === 1 && recapRows[0].textContent.includes("Belum ada data"))) {
                 alert('Tidak ada data rekapitulasi untuk diunduh.');
                 return;
             }
             recapRows.forEach(row => {
                 const cells = row.querySelectorAll('td');
                 recapData.push({
                     "Nama Anggota": cells[0].textContent, "Kelas": cells[1].textContent, "Hadir": parseInt(cells[2].textContent),
                     "Telat": parseInt(cells[3].textContent), "Sakit": parseInt(cells[4].textContent), "Izin": parseInt(cells[5].textContent),
                     "Alpha": parseInt(cells[6].textContent), "Persentase Kehadiran (%)": parseFloat(cells[7].textContent.replace('%','')),
                     "Poin": parseInt(cells[8].textContent)
                 });
             });
             
             const worksheet = XLSX.utils.json_to_sheet(recapData);
             const workbook = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(workbook, worksheet, "Rekapitulasi Absensi");
             XLSX.utils.sheet_add_aoa(worksheet, [
                [], ["INFORMASI UMUM"],
                ["Total Pertemuan Latihan:", getUniqueTrainingDates(allAttendanceData)],
                ["Total Anggota Terdaftar:", document.getElementById('totalAnggota').textContent],
             ], { origin: -1 });

            worksheet['!cols'] = [
                { wch: 25 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, 
                { wch: 10 }, { wch: 10 }, { wch: 20 }, { wch: 10 }
            ];
             XLSX.writeFile(workbook, "Rekap_Absensi_Paskibra.xlsx");
        });

        lucide.createIcons();
        showPage('loginPage');
    </script>
</body>
</html>
